import{a as G,b as H}from"./chunk-JYEPO45A.js";import"./chunk-MEBUCGCQ.js";import{d as S,g as E}from"./chunk-VTKZNL4V.js";import{a as J}from"./chunk-UYPCDNCC.js";import{a as k,c as F,f as T,g as A,h as L}from"./chunk-56Q56IV5.js";import{c as U,h as W}from"./chunk-EFACFY3A.js";import{Ja as N,Ka as q,ha as z,ia as j,ka as R,la as V,ma as $}from"./chunk-EWSGLXCW.js";import{$a as p,Ab as c,Bb as y,Cb as f,Db as b,Ec as D,Ha as M,Ja as o,Jb as O,Ka as _,bb as d,f as g,fc as P,gc as B,hb as r,ib as n,ic as I,jb as u,ka as v,nb as h,qb as C,ra as x,sa as w,sb as l}from"./chunk-R7MLKEAJ.js";function K(t,m){t&1&&(r(0,"div",4),u(1,"mat-spinner",5),n())}function Q(t,m){t&1&&(r(0,"mat-card",6)(1,"mat-card-content")(2,"mat-icon"),c(3,"devices"),n(),r(4,"p"),c(5,"\u76EE\u524D\u6C92\u6709\u501F\u7528\u4E2D\u7684\u8A2D\u5099"),n(),r(6,"a",7),c(7," \u700F\u89BD\u8A2D\u5099\u5217\u8868 "),n()()())}function X(t,m){if(t&1&&u(0,"img",22),t&2){let e=l().$implicit;d("src",e.device_image_url,M)("alt",e.device_name)}}function Y(t,m){t&1&&(r(0,"mat-icon"),c(1,"phone_android"),n())}function Z(t,m){if(t&1&&(r(0,"p",23)(1,"mat-icon"),c(2,"description"),n(),c(3),n()),t&2){let e=l().$implicit;o(3),f(" \u7528\u9014\uFF1A",e.purpose," ")}}function ee(t,m){t&1&&u(0,"mat-spinner",24)}function te(t,m){t&1&&(r(0,"span"),c(1,"\u6B78\u9084"),n())}function ie(t,m){if(t&1){let e=h();r(0,"mat-card",10)(1,"div",11)(2,"div",12),p(3,X,1,2,"img",13)(4,Y,2,0,"mat-icon",14),n(),r(5,"div",15)(6,"h3"),c(7),n(),r(8,"p",16),c(9),n(),r(10,"p",17)(11,"mat-icon"),c(12,"schedule"),n(),c(13),n(),p(14,Z,4,1,"p",18),n(),r(15,"div",19)(16,"button",20),C("click",function(){let i=x(e).$implicit,s=l(2);return w(s.returnDevice(i))}),p(17,ee,1,0,"mat-spinner",21)(18,te,2,0,"span",14),n()()()()}if(t&2){let e=m.$implicit,a=l(2);o(3),d("ngIf",e.device_image_url),o(),d("ngIf",!e.device_image_url),o(3),y(e.device_name),o(2),b("",e.device_brand," \xB7 ",e.device_model,""),o(4),f(" \u501F\u7528\u6642\u9593\uFF1A",a.formatDate(e.borrowed_at)," "),o(),d("ngIf",e.purpose),o(2),d("disabled",e.processing),o(),d("ngIf",e.processing),o(),d("ngIf",!e.processing)}}function ne(t,m){if(t&1&&(r(0,"div",8),p(1,ie,19,10,"mat-card",9),n()),t&2){let e=l();o(),d("ngForOf",e.borrows)}}var Oe=(()=>{class t{constructor(e,a,i,s){this.supabase=e,this.borrowService=a,this.dialog=i,this.snackBar=s,this.borrows=[],this.loading=!0,this.userEmail=""}ngOnInit(){return g(this,null,function*(){this.userEmail=this.supabase.currentUserValue?.email||"",yield this.loadMyBorrows()})}loadMyBorrows(){return g(this,null,function*(){this.loading=!0;try{let{data:e,error:a}=yield this.supabase.client.from("borrows").select(`
          id,
          device_id,
          borrowed_at,
          purpose,
          devices (
            name,
            brand,
            model,
            image_url
          )
        `).eq("borrower_email",this.userEmail).eq("status","active").order("borrowed_at",{ascending:!1});if(a)throw a;this.borrows=(e||[]).map(i=>({id:i.id,device_id:i.device_id,device_name:i.devices?.name||"\u672A\u77E5\u8A2D\u5099",device_brand:i.devices?.brand||"",device_model:i.devices?.model||"",device_image_url:i.devices?.image_url||null,borrowed_at:i.borrowed_at,purpose:i.purpose}))}catch(e){console.error("Load my borrows error:",e),this.snackBar.open("\u8F09\u5165\u501F\u7528\u8A18\u9304\u5931\u6557","\u95DC\u9589",{duration:5e3})}finally{this.loading=!1}})}returnDevice(e){this.dialog.open(G,{width:"400px",data:{deviceName:e.device_name}}).afterClosed().subscribe(i=>g(this,null,function*(){if(i){e.processing=!0;try{let s=yield this.borrowService.returnDevice(e.id);s.success?(this.snackBar.open("\u6B78\u9084\u6210\u529F\uFF01","\u95DC\u9589",{duration:3e3}),yield this.loadMyBorrows()):this.snackBar.open(s.error||"\u6B78\u9084\u5931\u6557","\u95DC\u9589",{duration:5e3})}catch(s){console.error("Return error:",s),this.snackBar.open(s.message||"\u6B78\u9084\u5931\u6557","\u95DC\u9589",{duration:5e3})}finally{e.processing=!1}}}))}formatDate(e){return new Date(e).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}static{this.\u0275fac=function(a){return new(a||t)(_(D),_(H),_(U),_(N))}}static{this.\u0275cmp=v({type:t,selectors:[["app-my-borrows"]],standalone:!0,features:[O],decls:6,vars:3,consts:[[1,"my-borrows-container"],["class","loading",4,"ngIf"],["class","empty-card",4,"ngIf"],["class","borrow-list",4,"ngIf"],[1,"loading"],["diameter","40"],[1,"empty-card"],["mat-raised-button","","color","primary","routerLink","/"],[1,"borrow-list"],["class","borrow-card",4,"ngFor","ngForOf"],[1,"borrow-card"],[1,"borrow-content"],[1,"device-image"],[3,"src","alt",4,"ngIf"],[4,"ngIf"],[1,"device-info"],[1,"device-model"],[1,"borrow-time"],["class","borrow-purpose",4,"ngIf"],[1,"actions"],["mat-raised-button","","color","warn",3,"click","disabled"],["diameter","20",4,"ngIf"],[3,"src","alt"],[1,"borrow-purpose"],["diameter","20"]],template:function(a,i){a&1&&(r(0,"div",0)(1,"h1"),c(2,"\u6211\u7684\u501F\u7528"),n(),p(3,K,2,0,"div",1)(4,Q,8,0,"mat-card",2)(5,ne,2,1,"div",3),n()),a&2&&(o(3),d("ngIf",i.loading),o(),d("ngIf",!i.loading&&i.borrows.length===0),o(),d("ngIf",!i.loading&&i.borrows.length>0))},dependencies:[I,P,B,E,S,T,k,F,R,j,z,$,V,J,L,A,W,q],styles:[".my-borrows-container[_ngcontent-%COMP%]{max-width:800px;margin:0 auto}h1[_ngcontent-%COMP%]{margin:0 0 24px;font-size:24px}.loading[_ngcontent-%COMP%]{display:flex;justify-content:center;padding:48px}.empty-card[_ngcontent-%COMP%]{text-align:center;padding:48px 24px}.empty-card[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:64px;width:64px;height:64px;color:var(--app-text-muted);margin-bottom:16px}.empty-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--app-text-muted);margin-bottom:24px}.borrow-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px}.borrow-card[_ngcontent-%COMP%]{overflow:hidden}.borrow-content[_ngcontent-%COMP%]{display:flex;align-items:center;gap:16px;padding:16px}.device-image[_ngcontent-%COMP%]{width:80px;height:80px;border-radius:8px;overflow:hidden;background:var(--app-surface-hover);display:flex;align-items:center;justify-content:center;flex-shrink:0}.device-image[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.device-image[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:40px;width:40px;height:40px;color:var(--app-text-muted)}.device-info[_ngcontent-%COMP%]{flex:1;min-width:0}.device-info[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 4px;font-size:18px}.device-model[_ngcontent-%COMP%]{margin:0 0 8px;color:var(--app-text-muted);font-size:14px}.borrow-time[_ngcontent-%COMP%], .borrow-purpose[_ngcontent-%COMP%]{margin:0;font-size:13px;color:var(--app-text-muted);display:flex;align-items:center;gap:4px}.borrow-time[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%], .borrow-purpose[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:16px;width:16px;height:16px}.actions[_ngcontent-%COMP%]{flex-shrink:0}.actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{min-width:80px}@media (max-width: 600px){.borrow-content[_ngcontent-%COMP%]{flex-wrap:wrap}.device-image[_ngcontent-%COMP%]{width:60px;height:60px}.device-info[_ngcontent-%COMP%]{flex-basis:calc(100% - 76px)}.actions[_ngcontent-%COMP%]{width:100%;margin-top:8px}.actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}}"]})}}return t})();export{Oe as MyBorrowsComponent};
