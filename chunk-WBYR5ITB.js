import{a as Ce,b as Me,c as we,d as ye,e as xe,f as Ee,g as Se,h as De,i as ve,j as be,k as Be,l as Ue,m as A,n as Ie}from"./chunk-AE7LEQZC.js";import{a as ie,b as F}from"./chunk-MDRIXYBX.js";import{a as he}from"./chunk-UYPCDNCC.js";import{a as X,f as Y,g as ae,h as re}from"./chunk-56Q56IV5.js";import{a as de,b as ce,c as pe,d as ue,e as fe,f as ge,g as _e,h as k}from"./chunk-EFACFY3A.js";import{Ja as le,Ka as se,X as Q,aa as Z,b as N,ba as ee,f as z,fa as te,ga as T,ha as R,i as G,ja as ne,ka as V,l as $,la as oe,ma as me,n as J,o as K,p as P}from"./chunk-EWSGLXCW.js";import{$a as p,Ab as o,Bb as j,Cb as O,Ec as H,Fb as y,Gb as x,Hb as E,Ja as l,Jb as B,Ka as g,bb as d,ec as q,f as _,gc as U,hb as n,ib as i,ic as I,jb as v,ka as D,kb as h,lb as C,nb as b,qb as M,ra as u,sa as f,sb as w,zb as L}from"./chunk-R7MLKEAJ.js";function ke(e,m){e&1&&(n(0,"mat-error"),o(1,"Email \u5FC5\u586B"),i())}function Ae(e,m){e&1&&(n(0,"mat-error"),o(1,"Email \u683C\u5F0F\u4E0D\u6B63\u78BA"),i())}function Oe(e,m){e&1&&(n(0,"mat-error"),o(1,"\u5BC6\u78BC\u81F3\u5C11 6 \u500B\u5B57\u5143"),i())}function We(e,m){e&1&&(n(0,"mat-error"),o(1,"\u5BC6\u78BC\u4E0D\u4E00\u81F4"),i())}var W=class{constructor(){this.emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/}isErrorState(m){let t=(m?.value??"").toString().trim();return!(m?.dirty||m?.touched)?!1:t.length===0||!this.emailRegex.test(t)}},Pe=(()=>{class e{constructor(t,a){this.dialogRef=t,this.data=a,this.email="",this.password="",this.confirmPassword="",this.role="user",this.emailPattern="^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$",this.emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,this.emailErrorMatcher=new W}get isValid(){return this.email.trim().length>0&&this.emailRegex.test(this.email.trim())&&this.password.length>=6&&this.password===this.confirmPassword}get showPasswordMismatch(){return this.confirmPassword.length>0&&this.password!==this.confirmPassword}get showPasswordTooShort(){return this.password.length>0&&this.password.length<6}showEmailRequired(t){return!!(t?.dirty||t?.touched)&&this.email.trim().length===0}showEmailInvalid(t){let a=this.email.trim();return!!(t?.dirty||t?.touched)&&a.length>0&&!this.emailRegex.test(a)}onConfirm(){if(this.isValid){let t={email:this.email.trim(),password:this.password,role:this.role};this.dialogRef.close(t)}}static{this.\u0275fac=function(a){return new(a||e)(g(de),g(ce))}}static{this.\u0275cmp=D({type:e,selectors:[["app-user-form-dialog"]],standalone:!0,features:[B],decls:33,vars:11,consts:[["emailModel","ngModel"],["mat-dialog-title",""],["appearance","outline",1,"full-width"],["matInput","","type","email","name","email","placeholder","user@example.com","required","",3,"ngModelChange","ngModel","errorStateMatcher","pattern"],[4,"ngIf"],["matInput","","type","password","placeholder","\u81F3\u5C11 6 \u500B\u5B57\u5143","minlength","6","required","",3,"ngModelChange","ngModel"],["matInput","","type","password","placeholder","\u518D\u6B21\u8F38\u5165\u5BC6\u78BC","required","",3,"ngModelChange","ngModel"],["required","",3,"ngModelChange","ngModel"],["value","user"],["value","admin"],["align","end"],["mat-button","","mat-dialog-close",""],["mat-raised-button","","color","primary",3,"click","disabled"]],template:function(a,r){if(a&1){let s=b();n(0,"h2",1),o(1,"\u65B0\u589E\u7528\u6236"),i(),n(2,"mat-dialog-content")(3,"mat-form-field",2)(4,"mat-label"),o(5,"Email"),i(),n(6,"input",3,0),E("ngModelChange",function(c){return u(s),x(r.email,c)||(r.email=c),f(c)}),i(),p(8,ke,2,0,"mat-error",4)(9,Ae,2,0,"mat-error",4),i(),n(10,"mat-form-field",2)(11,"mat-label"),o(12,"\u5BC6\u78BC"),i(),n(13,"input",5),E("ngModelChange",function(c){return u(s),x(r.password,c)||(r.password=c),f(c)}),i(),p(14,Oe,2,0,"mat-error",4),i(),n(15,"mat-form-field",2)(16,"mat-label"),o(17,"\u78BA\u8A8D\u5BC6\u78BC"),i(),n(18,"input",6),E("ngModelChange",function(c){return u(s),x(r.confirmPassword,c)||(r.confirmPassword=c),f(c)}),i(),p(19,We,2,0,"mat-error",4),i(),n(20,"mat-form-field",2)(21,"mat-label"),o(22,"\u89D2\u8272"),i(),n(23,"mat-select",7),E("ngModelChange",function(c){return u(s),x(r.role,c)||(r.role=c),f(c)}),n(24,"mat-option",8),o(25,"\u4E00\u822C\u7528\u6236"),i(),n(26,"mat-option",9),o(27,"\u7BA1\u7406\u54E1"),i()()()(),n(28,"mat-dialog-actions",10)(29,"button",11),o(30,"\u53D6\u6D88"),i(),n(31,"button",12),M("click",function(){return u(s),f(r.onConfirm())}),o(32," \u5EFA\u7ACB\u7528\u6236 "),i()()}if(a&2){let s=L(7);l(6),y("ngModel",r.email),d("errorStateMatcher",r.emailErrorMatcher)("pattern",r.emailPattern),l(2),d("ngIf",r.showEmailRequired(s)),l(),d("ngIf",r.showEmailInvalid(s)),l(4),y("ngModel",r.password),l(),d("ngIf",r.showPasswordTooShort),l(4),y("ngModel",r.confirmPassword),l(),d("ngIf",r.showPasswordMismatch),l(4),y("ngModel",r.role),l(8),d("disabled",!r.isValid)}},dependencies:[I,U,P,N,z,$,J,K,G,k,ue,fe,_e,ge,T,te,Z,ee,F,ie,A,Ue,Q,V,R],styles:["mat-dialog-content[_ngcontent-%COMP%]{min-width:min(350px,80vw);overflow:visible}.full-width[_ngcontent-%COMP%]{width:100%}mat-form-field[_ngcontent-%COMP%]{margin:4px 0 8px}"]})}}return e})();function Le(e,m){e&1&&(n(0,"div",5),v(1,"mat-spinner",6),i())}function je(e,m){e&1&&(n(0,"th",17),o(1,"Email"),i())}function qe(e,m){if(e&1&&(n(0,"td",18)(1,"strong"),o(2),i()()),e&2){let t=m.$implicit;l(2),j(t.email)}}function He(e,m){e&1&&(n(0,"th",17),o(1,"\u89D2\u8272"),i())}function Ne(e,m){if(e&1&&(n(0,"td",18)(1,"span",19),o(2),i()()),e&2){let t=m.$implicit;l(),d("ngClass",t.role),l(),O(" ",t.role==="admin"?"\u7BA1\u7406\u54E1":"\u4E00\u822C\u7528\u6236"," ")}}function ze(e,m){e&1&&(n(0,"th",17),o(1,"\u5EFA\u7ACB\u6642\u9593"),i())}function Ge(e,m){if(e&1&&(n(0,"td",18),o(1),i()),e&2){let t=m.$implicit,a=w(2);l(),O(" ",a.formatDate(t.created_at)," ")}}function $e(e,m){e&1&&(n(0,"th",17),o(1,"\u64CD\u4F5C"),i())}function Je(e,m){if(e&1){let t=b();n(0,"td",18)(1,"button",20),M("click",function(){let r=u(t).$implicit,s=w(2);return f(s.deleteUser(r))}),n(2,"mat-icon"),o(3,"delete"),i()()()}if(e&2){let t=m.$implicit,a=w(2);l(),d("disabled",t.id===a.currentUserId)}}function Ke(e,m){e&1&&v(0,"tr",21)}function Qe(e,m){e&1&&v(0,"tr",22)}function Xe(e,m){e&1&&(n(0,"div",23)(1,"mat-icon"),o(2,"people_outline"),i(),n(3,"p"),o(4,"\u5C1A\u7121\u7528\u6236\u8CC7\u6599"),i()())}function Ye(e,m){if(e&1&&(n(0,"mat-card")(1,"table",7),h(2,8),p(3,je,2,0,"th",9)(4,qe,3,1,"td",10),C(),h(5,11),p(6,He,2,0,"th",9)(7,Ne,3,2,"td",10),C(),h(8,12),p(9,ze,2,0,"th",9)(10,Ge,2,1,"td",10),C(),h(11,13),p(12,$e,2,0,"th",9)(13,Je,4,1,"td",10),C(),p(14,Ke,1,0,"tr",14)(15,Qe,1,0,"tr",15),i(),p(16,Xe,5,0,"div",16),i()),e&2){let t=w();l(),d("dataSource",t.users),l(13),d("matHeaderRowDef",t.displayedColumns),l(),d("matRowDefColumns",t.displayedColumns),l(),d("ngIf",t.users.length===0)}}var Ft=(()=>{class e{constructor(t,a,r){this.supabase=t,this.dialog=a,this.snackBar=r,this.users=[],this.loading=!0,this.displayedColumns=["email","role","created_at","actions"],this.currentUserId=""}ngOnInit(){return _(this,null,function*(){this.currentUserId=this.supabase.currentUserValue?.id||"",yield this.loadUsers()})}loadUsers(){return _(this,null,function*(){this.loading=!0;try{let{data:t,error:a}=yield this.supabase.client.from("users").select("*").order("created_at",{ascending:!1});if(a)throw a;this.users=t||[]}catch(t){console.error("Load users error:",t),this.snackBar.open("\u8F09\u5165\u7528\u6236\u5217\u8868\u5931\u6557","\u95DC\u9589",{duration:5e3})}finally{this.loading=!1}})}openAddDialog(){this.dialog.open(Pe,{width:"400px",data:{mode:"add"}}).afterClosed().subscribe(a=>_(this,null,function*(){a&&(yield this.createUser(a))}))}createUser(t){return _(this,null,function*(){try{let{data:a,error:r}=yield this.supabase.client.rpc("create_user",{p_email:t.email,p_password:t.password,p_role:t.role});if(r)throw r;this.snackBar.open("\u7528\u6236\u5EFA\u7ACB\u6210\u529F","\u95DC\u9589",{duration:3e3}),yield this.loadUsers()}catch(a){console.error("Create user error:",a),this.snackBar.open(a.message||"\u5EFA\u7ACB\u7528\u6236\u5931\u6557","\u95DC\u9589",{duration:5e3})}})}deleteUser(t){this.dialog.open(Ie,{width:"320px",data:{title:"\u78BA\u8A8D\u522A\u9664",message:`\u78BA\u5B9A\u8981\u522A\u9664\u7528\u6236\u300C${t.email}\u300D\u55CE\uFF1F\u6B64\u64CD\u4F5C\u7121\u6CD5\u5FA9\u539F\u3002`,confirmText:"\u522A\u9664",cancelText:"\u53D6\u6D88",confirmColor:"warn"}}).afterClosed().subscribe(r=>_(this,null,function*(){if(r)try{let{error:s}=yield this.supabase.client.rpc("delete_user",{p_user_id:t.id});if(s)throw s;this.snackBar.open("\u7528\u6236\u5DF2\u522A\u9664","\u95DC\u9589",{duration:3e3}),yield this.loadUsers()}catch(s){console.error("Delete user error:",s),this.snackBar.open(s.message||"\u522A\u9664\u7528\u6236\u5931\u6557","\u95DC\u9589",{duration:5e3})}}))}formatDate(t){return new Date(t).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}static{this.\u0275fac=function(a){return new(a||e)(g(H),g(pe),g(le))}}static{this.\u0275cmp=D({type:e,selectors:[["app-user-management"]],standalone:!0,features:[B],decls:10,vars:2,consts:[[1,"user-management-container"],[1,"header"],["mat-raised-button","","color","primary",3,"click"],["class","loading",4,"ngIf"],[4,"ngIf"],[1,"loading"],["diameter","40"],["mat-table","",1,"user-table",3,"dataSource"],["matColumnDef","email"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","role"],["matColumnDef","created_at"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["class","empty-state",4,"ngIf"],["mat-header-cell",""],["mat-cell",""],[1,"role-chip",3,"ngClass"],["mat-icon-button","","color","warn",3,"click","disabled"],["mat-header-row",""],["mat-row",""],[1,"empty-state"]],template:function(a,r){a&1&&(n(0,"div",0)(1,"div",1)(2,"h1"),o(3,"\u7528\u6236\u7BA1\u7406"),i(),n(4,"button",2),M("click",function(){return r.openAddDialog()}),n(5,"mat-icon"),o(6,"person_add"),i(),o(7," \u65B0\u589E\u7528\u6236 "),i()(),p(8,Le,2,0,"div",3)(9,Ye,17,4,"mat-card",4),i()),a&2&&(l(8),d("ngIf",r.loading),l(),d("ngIf",!r.loading))},dependencies:[I,q,U,P,Y,X,Be,Ce,we,Se,ye,Me,De,xe,Ee,ve,be,V,R,ne,me,oe,he,re,ae,k,se,T,F,A],styles:[".user-management-container[_ngcontent-%COMP%]{padding:24px;max-width:1200px;margin:0 auto}.header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}.header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0;font-size:24px}.loading[_ngcontent-%COMP%]{display:flex;justify-content:center;padding:48px}mat-card[_ngcontent-%COMP%]{overflow:hidden}.user-table[_ngcontent-%COMP%]{width:100%}.role-chip[_ngcontent-%COMP%]{display:inline-block;padding:4px 12px;border-radius:16px;font-size:12px;font-weight:500}.role-chip.admin[_ngcontent-%COMP%]{background:#9c27b033;color:#ce93d8}.role-chip.user[_ngcontent-%COMP%]{background:#2196f333;color:#90caf9}.empty-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:48px;color:var(--app-text-muted)}.empty-state[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:48px;width:48px;height:48px;margin-bottom:16px}"]})}}return e})();export{Ft as UserManagementComponent};
