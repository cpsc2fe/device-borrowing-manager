import{a as ue,b as fe,c as ge,d as _e,e as Me,f as Ce,g as he,h as we,i as xe,j as ye,k as De,l as Se,m as F,n as be}from"./chunk-XJZVJRBH.js";import{a as pe}from"./chunk-WNIR6GMR.js";import{a as oe,b as re,c as me,d as le,e as se,f as de,g as ce,h as B}from"./chunk-SRPUPYMG.js";import{a as J,f as K,g as Q,k as X,l as v,m as Y,n as U,o as $,p as ee,q as ne,r as ae}from"./chunk-ZVD7ITEB.js";import{Y as G,b as L,ba as I,ca as Z,da as T,ea as te,f as H,fa as ie,i as q,l as z,n as N,o as E}from"./chunk-UEBNNHWR.js";import{$a as p,Ab as r,Bb as A,Cb as P,Ec as j,Fb as x,Gb as y,Hb as D,Ja as m,Jb as S,Ka as u,bb as c,ec as V,f,gc as W,hb as n,ib as a,ic as b,jb as w,ka as h,kb as g,lb as _,nb as R,qb as M,ra as k,sa as O,sb as C}from"./chunk-YVT4I57R.js";var Ee=(()=>{class e{constructor(t,i){this.dialogRef=t,this.data=i,this.email="",this.password="",this.role="user"}get isValid(){return this.email.trim().length>0&&this.email.includes("@")&&this.password.length>=6}onConfirm(){if(this.isValid){let t={email:this.email.trim(),password:this.password,role:this.role};this.dialogRef.close(t)}}static{this.\u0275fac=function(i){return new(i||e)(u(oe),u(re))}}static{this.\u0275cmp=h({type:e,selectors:[["app-user-form-dialog"]],standalone:!0,features:[S],decls:24,vars:4,consts:[["mat-dialog-title",""],["appearance","outline",1,"full-width"],["matInput","","type","email","placeholder","user@example.com","required","",3,"ngModelChange","ngModel"],["matInput","","type","password","placeholder","\u81F3\u5C11 6 \u500B\u5B57\u5143","minlength","6","required","",3,"ngModelChange","ngModel"],["required","",3,"ngModelChange","ngModel"],["value","user"],["value","admin"],["align","end"],["mat-button","","mat-dialog-close",""],["mat-raised-button","","color","primary",3,"click","disabled"]],template:function(i,o){i&1&&(n(0,"h2",0),r(1,"\u65B0\u589E\u7528\u6236"),a(),n(2,"mat-dialog-content")(3,"mat-form-field",1)(4,"mat-label"),r(5,"Email"),a(),n(6,"input",2),D("ngModelChange",function(d){return y(o.email,d)||(o.email=d),d}),a()(),n(7,"mat-form-field",1)(8,"mat-label"),r(9,"\u5BC6\u78BC"),a(),n(10,"input",3),D("ngModelChange",function(d){return y(o.password,d)||(o.password=d),d}),a()(),n(11,"mat-form-field",1)(12,"mat-label"),r(13,"\u89D2\u8272"),a(),n(14,"mat-select",4),D("ngModelChange",function(d){return y(o.role,d)||(o.role=d),d}),n(15,"mat-option",5),r(16,"\u4E00\u822C\u7528\u6236"),a(),n(17,"mat-option",6),r(18,"\u7BA1\u7406\u54E1"),a()()()(),n(19,"mat-dialog-actions",7)(20,"button",8),r(21,"\u53D6\u6D88"),a(),n(22,"button",9),M("click",function(){return o.onConfirm()}),r(23," \u5EFA\u7ACB\u7528\u6236 "),a()()),i&2&&(m(6),x("ngModel",o.email),m(4),x("ngModel",o.password),m(4),x("ngModel",o.role),m(8),c("disabled",!o.isValid))},dependencies:[b,E,L,H,z,N,q,B,le,se,ce,de,v,X,Q,U,Y,F,Se,G,T,I],styles:["mat-dialog-content[_ngcontent-%COMP%]{min-width:min(350px,80vw)}.full-width[_ngcontent-%COMP%]{width:100%}mat-form-field[_ngcontent-%COMP%]{margin-bottom:8px}"]})}}return e})();function Te(e,l){e&1&&(n(0,"div",5),w(1,"mat-spinner",6),a())}function Be(e,l){e&1&&(n(0,"th",17),r(1,"Email"),a())}function Fe(e,l){if(e&1&&(n(0,"td",18)(1,"strong"),r(2),a()()),e&2){let t=l.$implicit;m(2),A(t.email)}}function Pe(e,l){e&1&&(n(0,"th",17),r(1,"\u89D2\u8272"),a())}function ke(e,l){if(e&1&&(n(0,"td",18)(1,"span",19),r(2),a()()),e&2){let t=l.$implicit;m(),c("ngClass",t.role),m(),P(" ",t.role==="admin"?"\u7BA1\u7406\u54E1":"\u4E00\u822C\u7528\u6236"," ")}}function Oe(e,l){e&1&&(n(0,"th",17),r(1,"\u5EFA\u7ACB\u6642\u9593"),a())}function Re(e,l){if(e&1&&(n(0,"td",18),r(1),a()),e&2){let t=l.$implicit,i=C(2);m(),P(" ",i.formatDate(t.created_at)," ")}}function Ae(e,l){e&1&&(n(0,"th",17),r(1,"\u64CD\u4F5C"),a())}function Ve(e,l){if(e&1){let t=R();n(0,"td",18)(1,"button",20),M("click",function(){let o=k(t).$implicit,s=C(2);return O(s.deleteUser(o))}),n(2,"mat-icon"),r(3,"delete"),a()()()}if(e&2){let t=l.$implicit,i=C(2);m(),c("disabled",t.id===i.currentUserId)}}function We(e,l){e&1&&w(0,"tr",21)}function je(e,l){e&1&&w(0,"tr",22)}function Le(e,l){e&1&&(n(0,"div",23)(1,"mat-icon"),r(2,"people_outline"),a(),n(3,"p"),r(4,"\u5C1A\u7121\u7528\u6236\u8CC7\u6599"),a()())}function He(e,l){if(e&1&&(n(0,"mat-card")(1,"table",7),g(2,8),p(3,Be,2,0,"th",9)(4,Fe,3,1,"td",10),_(),g(5,11),p(6,Pe,2,0,"th",9)(7,ke,3,2,"td",10),_(),g(8,12),p(9,Oe,2,0,"th",9)(10,Re,2,1,"td",10),_(),g(11,13),p(12,Ae,2,0,"th",9)(13,Ve,4,1,"td",10),_(),p(14,We,1,0,"tr",14)(15,je,1,0,"tr",15),a(),p(16,Le,5,0,"div",16),a()),e&2){let t=C();m(),c("dataSource",t.users),m(13),c("matHeaderRowDef",t.displayedColumns),m(),c("matRowDefColumns",t.displayedColumns),m(),c("ngIf",t.users.length===0)}}var St=(()=>{class e{constructor(t,i,o){this.supabase=t,this.dialog=i,this.snackBar=o,this.users=[],this.loading=!0,this.displayedColumns=["email","role","created_at","actions"],this.currentUserId=""}ngOnInit(){return f(this,null,function*(){this.currentUserId=this.supabase.currentUserValue?.id||"",yield this.loadUsers()})}loadUsers(){return f(this,null,function*(){this.loading=!0;try{let{data:t,error:i}=yield this.supabase.client.from("users").select("*").order("created_at",{ascending:!1});if(i)throw i;this.users=t||[]}catch(t){console.error("Load users error:",t),this.snackBar.open("\u8F09\u5165\u7528\u6236\u5217\u8868\u5931\u6557","\u95DC\u9589",{duration:5e3})}finally{this.loading=!1}})}openAddDialog(){this.dialog.open(Ee,{width:"400px",data:{mode:"add"}}).afterClosed().subscribe(i=>f(this,null,function*(){i&&(yield this.createUser(i))}))}createUser(t){return f(this,null,function*(){try{let{data:i,error:o}=yield this.supabase.client.rpc("create_user",{p_email:t.email,p_password:t.password,p_role:t.role});if(o)throw o;this.snackBar.open("\u7528\u6236\u5EFA\u7ACB\u6210\u529F","\u95DC\u9589",{duration:3e3}),yield this.loadUsers()}catch(i){console.error("Create user error:",i),this.snackBar.open(i.message||"\u5EFA\u7ACB\u7528\u6236\u5931\u6557","\u95DC\u9589",{duration:5e3})}})}deleteUser(t){this.dialog.open(be,{width:"320px",data:{title:"\u78BA\u8A8D\u522A\u9664",message:`\u78BA\u5B9A\u8981\u522A\u9664\u7528\u6236\u300C${t.email}\u300D\u55CE\uFF1F\u6B64\u64CD\u4F5C\u7121\u6CD5\u5FA9\u539F\u3002`,confirmText:"\u522A\u9664",cancelText:"\u53D6\u6D88",confirmColor:"warn"}}).afterClosed().subscribe(o=>f(this,null,function*(){if(o)try{let{error:s}=yield this.supabase.client.rpc("delete_user",{p_user_id:t.id});if(s)throw s;this.snackBar.open("\u7528\u6236\u5DF2\u522A\u9664","\u95DC\u9589",{duration:3e3}),yield this.loadUsers()}catch(s){console.error("Delete user error:",s),this.snackBar.open(s.message||"\u522A\u9664\u7528\u6236\u5931\u6557","\u95DC\u9589",{duration:5e3})}}))}formatDate(t){return new Date(t).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}static{this.\u0275fac=function(i){return new(i||e)(u(j),u(me),u(ne))}}static{this.\u0275cmp=h({type:e,selectors:[["app-user-management"]],standalone:!0,features:[S],decls:10,vars:2,consts:[[1,"user-management-container"],[1,"header"],["mat-raised-button","","color","primary",3,"click"],["class","loading",4,"ngIf"],[4,"ngIf"],[1,"loading"],["diameter","40"],["mat-table","",1,"user-table",3,"dataSource"],["matColumnDef","email"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","role"],["matColumnDef","created_at"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["class","empty-state",4,"ngIf"],["mat-header-cell",""],["mat-cell",""],[1,"role-chip",3,"ngClass"],["mat-icon-button","","color","warn",3,"click","disabled"],["mat-header-row",""],["mat-row",""],[1,"empty-state"]],template:function(i,o){i&1&&(n(0,"div",0)(1,"div",1)(2,"h1"),r(3,"\u7528\u6236\u7BA1\u7406"),a(),n(4,"button",2),M("click",function(){return o.openAddDialog()}),n(5,"mat-icon"),r(6,"person_add"),a(),r(7," \u65B0\u589E\u7528\u6236 "),a()(),p(8,Te,2,0,"div",3)(9,He,17,4,"mat-card",4),a()),i&2&&(m(8),c("ngIf",o.loading),m(),c("ngIf",!o.loading))},dependencies:[b,V,W,E,K,J,De,ue,ge,he,_e,fe,we,Me,Ce,xe,ye,T,I,Z,ie,te,pe,ee,$,B,ae,v,U,F],styles:[".user-management-container[_ngcontent-%COMP%]{padding:24px;max-width:1200px;margin:0 auto}.header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}.header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0;font-size:24px}.loading[_ngcontent-%COMP%]{display:flex;justify-content:center;padding:48px}mat-card[_ngcontent-%COMP%]{overflow:hidden}.user-table[_ngcontent-%COMP%]{width:100%}.role-chip[_ngcontent-%COMP%]{display:inline-block;padding:4px 12px;border-radius:16px;font-size:12px;font-weight:500}.role-chip.admin[_ngcontent-%COMP%]{background:#9c27b033;color:#ce93d8}.role-chip.user[_ngcontent-%COMP%]{background:#2196f333;color:#90caf9}.empty-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:48px;color:var(--app-text-muted)}.empty-state[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:48px;width:48px;height:48px;margin-bottom:16px}"]})}}return e})();export{St as UserManagementComponent};
